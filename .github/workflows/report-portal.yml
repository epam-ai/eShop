name: Report Portal

on:
  push:
    branches: [ release/8.0 ]

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-test:
    name: Build, Test and Analyze
    runs-on: ubuntu-latest
    env:
      ASSISTANT_ID: ${{ secrets.ASSISTANT_ID }}
    
    steps:
      # 1. Checkout source code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevance of analysis

      # 2. Install required dependencies (Setup environment)
      # Uses global.json to pick the correct .NET SDK version
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.417'

      - name: Show selected SDK
        run: dotnet --version
      - name: Update Workloads
        run: dotnet workload update
      - name: Install Workloads
        run: dotnet workload install aspire
      - name: Build 
        run: dotnet build eShop.Web.slnf

      - name: Run Unit Tests with ReportPortal
        run: dotnet test eShop.Web.slnf --logger:"console;verbosity=normal" --logger:"ReportPortal"
        env:
          RP_UUID: ${{ secrets.REPORTPORTAL_API_KEY }}
          RP_ENDPOINT: ${{ secrets.REPORTPORTAL_ENDPOINT }}
          RP_PROJECT: ${{ secrets.REPORTPORTAL_PROJECT }}
          RP_LAUNCH: >
            GitHubActions |
            ${{ github.repository }} |
            UnitTests |
            ${{ github.ref_name }} |
            #${{ github.run_number }}