name: Report Portal

on:
  push:
    branches: [ release/8.0 ]

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-test:
    name: Build, Test and Analyze
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevance of analysis
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.417'
      - name: Show selected SDK
        run: dotnet --version
      - name: Update Workloads
        run: dotnet workload update
      - name: Install Workloads
        run: dotnet workload install aspire
      - name: Build 
        run: dotnet build eShop.Web.slnf

      - name: Run Unit Tests with ReportPortal
        run: dotnet test tests/Ordering.UnitTests/Ordering.UnitTests.csproj --logger:"console;verbosity=normal" --logger:"ReportPortal"
        env:
          ReportPortal__Server__Url: ${{ secrets.REPORTPORTAL_ENDPOINT }}
          ReportPortal__Server__Project: ${{ secrets.REPORTPORTAL_PROJECT }}
          ReportPortal__Server__ApiKey: ${{ secrets.REPORTPORTAL_API_KEY }}
          ReportPortal__Launch__Name: >
            GitHubActions |
            ${{ github.repository }} |
            Ordering.UnitTests |
            ${{ github.ref_name }} |
            #${{ github.run_number }}